{% extends "base.html" %}

{% block content %}
<style>
  .table-font-sm td,
  .table-font-sm th {
    font-size: 0.8rem !important;
    vertical-align: middle;
  }

  .details-toggle {
    cursor: pointer;
    display: inline-block;
    transition: transform 0.2s ease-in-out;
  }

  .details-toggle[aria-expanded="true"] {
    transform: rotate(90deg);
  }

  .log-details-row td {
    padding: 0 !important;
    border: 0;
  }

  .details-content {
    background-color: #f8f9fa;
    padding: 1rem;
  }

  .details-table {
    margin-bottom: 0;
  }
</style>

<h1>Logs de Alterações</h1>

<form method="GET" action="{% url 'lista_logs' %}" class="mb-4 p-3 border rounded bg-light">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label for="tipo" class="form-label">Filtrar por Despesa</label>
      <select name="tipo" id="tipo" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for tipo in tipos_unicos %}
        <option value="{{ tipo }}" {% if tipo == current_tipo %}selected{% endif %}>{{ tipo }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="usuario" class="form-label">Filtrar por Usuário</label>
      <select name="usuario" id="usuario" class="form-select form-select-sm">
        <option value="">Todos</option>
        {% for u in usuarios_unicos %}
        <option value="{{ u.id }}" {% if u.id == current_usuario %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6 d-flex justify-content-start align-items-end">
      <button type="submit" class="btn btn-primary btn-sm me-2">Aplicar Filtros</button>
      <a href="{% url 'lista_logs' %}" class="btn btn-secondary btn-sm">Limpar Filtros</a>
    </div>
  </div>
</form>

<div class="d-flex justify-content-end mb-2">
  <form action="{% url 'limpar_logs' %}" method="post">
    {% csrf_token %}
    <button type="submit" class="btn btn-outline-danger btn-sm"
      onclick="return confirm('Tem certeza que deseja apagar TODOS os logs? Esta ação não pode ser desfeita.');">
      Limpar Todos os Logs
    </button>
  </form>
</div>

<table class="table table-bordered table-font-sm">
  <thead>
    <tr>
      <th>
        <a href="?sort=date_desc&tipo={{current_tipo}}&usuario={{current_usuario}}">Quando ▼</a> |
        <a href="?sort=date_asc&tipo={{current_tipo}}&usuario={{current_usuario}}">▲</a>
      </th>
      <th>Usuário</th>
      <th>Despesa</th>
      <th>Mês Ref.</th>
      <th>Ação</th>
      <th>Descrição</th>
      <th>
        <a href="?sort=valor_desc&tipo={{current_tipo}}&usuario={{current_usuario}}">Valor ▼</a> |
        <a href="?sort=valor_asc&tipo={{current_tipo}}&usuario={{current_usuario}}">▲</a>
      </th>
    </tr>
  </thead>
  <tbody>
      {% for log in logs %}
        <tr class="{% if 'Exclusão' in log.modelo %}table-danger{% endif %}">
          <td>{{ log.criado_em|date:"d/m/Y H:i" }}</td>
          <td>{{ log.usuario.username }}</td>
          <td>
            {% if 'Exclusão' not in log.modelo %}
              {{ log.modelo }}
            {% endif %}
          </td>
          <td>
            {% if log.mes_referencia %}
              {{ log.get_mes_referencia_display }}/{{ log.ano_referencia }}
            {% elif log.despesa %}
              {{ log.despesa.get_mes_display }}/{{ log.despesa.ano }}
            {% endif %}
          </td>
          <td>{{ log.acao }}</td>
          <td>
            {% if log.snapshot.nf_info %}
            <span class="details-toggle me-2" data-bs-toggle="collapse" data-bs-target="#details-{{ log.id }}" aria-expanded="false" aria-controls="details-{{ log.id }}">
              ▶
            </span>
            {% endif %}
            {{ log.descricao }}
          </td>
          <td>
            {% if log.valor %}
            R$ {{ log.valor|floatformat:2 }}
            {% endif %}
          </td>
        </tr>
    
        {% if log.snapshot.nf_info %}
        <tr class="log-details-row">
          <td colspan="7">
            <div class="collapse" id="details-{{ log.id }}">
              <div class="details-content">
                <h6>Detalhes das Notas Fiscais (Registrado em {{ log.criado_em|date:"d/m/Y H:i" }})</h6>
                <table class="table table-sm details-table">
                  <thead>
                    <tr>
                      <th>Fornecedor</th>
                      <th>Histórico</th>
                      <th>NF nº</th>
                      <th>Tipo</th>
                      <th>Valor (R$)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for nf in log.snapshot.nf_info %}
                    <tr>
                      <td>{{ nf.fornecedor|default:"-" }}</td>
                      <td>{{ nf.historico|default:"-" }}</td>
                      <td>{{ nf.numero|default:"-" }}</td>
                      <td>{% if nf.tipo == 'sem' %}Sem a Sala{% else %}Com a Sala{% endif %}</td>
                      <td>{{ nf.valor|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </td>
        </tr>
        {% endif %}
    
      {% empty %}
        <tr>
          <td colspan="7" class="text-center">Nenhum log encontrado para os filtros selecionados.</td>
        </tr>
      {% endfor %}
    </tbody>
</table>
{% endblock %}

{# --- BLOCO DE SCRIPTS ADICIONADO AQUI --- #}
{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
