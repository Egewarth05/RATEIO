{% extends 'base.html' %}
{% load extras %}
{% block title %}Nova Despesa{% endblock %}

{% block content %}
<style>
   /* destaca a coluna “Total” (kWh e R$) na tabela de energia */
     #energia-table th,
     #energia-table td {
       text-align: center;
       vertical-align: middle;
     }

     /* mantém o fundo só na coluna destacada */
     #energia-table th.highlight,
     #energia-table td.highlight {
       background-color: #e9f7ff;
     }
</style>

  <style>
    #rateio-padrao {
      width: 100% !important;
      table-layout: fixed;
    }
    #rateio-padrao th,
    #rateio-padrao td {
      vertical-align: middle !important;
      font-size: 1.2rem !important;
      text-align: center !important;
      word-wrap: break-word;
    }
    #rateio-padrao th:nth-child(1),
    #rateio-padrao td:nth-child(1) { width: 40%; }
    #rateio-padrao th:nth-child(2),
    #rateio-padrao td:nth-child(2) { width: 60%; }

  </style>
  <h1 class="mb-4">Cadastrar Nova Despesa</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form id="filtro-form" method="get" class="row mb-4">
    <div class="col-md-3">
      <label for="id_tipo">Tipo:</label>
      <select name="tipo" id="id_tipo" class="form-select form-select-lg" onchange="this.form.submit()">
        {% for t in form.fields.tipo.queryset %}
          <option value="{{ t.id }}"
            {% if t.id|stringformat:"s" == tipo_id|stringformat:"s" %}selected{% endif %}>
            {{ t.nome }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="id_mes">Mês:</label>
      <select name="mes" id="id_mes" class="form-select form-select-lg" onchange="this.form.submit()">
        {% with nomes_meses="Janeiro,Fevereiro,Março,Abril,Maio,Junho,Julho,Agosto,Setembro,Outubro,Novembro,Dezembro"|split:"," %}
          {% for nome in nomes_meses %}
            <option value="{{ forloop.counter }}"
              {% if forloop.counter|stringformat:"s" == mes|stringformat:"s" %}selected{% endif %}>
              {{ nome }}
            </option>
          {% endfor %}
        {% endwith %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="id_ano">Ano:</label>
      <select name="ano" id="id_ano" class="form-select form-select-lg" onchange="this.form.submit()">
        {% for i in "2025,2026,2027"|split:"," %}
          <option value="{{ i }}"
            {% if i|stringformat:"s" == ano|stringformat:"s" %}selected{% endif %}>
            {{ i }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>

  <form method="post" class="card p-4 shadow">
    {% csrf_token %}
    <input type="hidden" name="tipo" value="{{ tipo_id }}">
    <input type="hidden" name="mes"   value="{{ mes }}">
    <input type="hidden" name="ano"   value="{{ ano }}">
    <input type="hidden" id="id_valor_total" name="valor_total" value="">

    {% if form.errors %}
      <div class="alert alert-danger"><ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ field.label }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul></div>
    {% endif %}

    <!-- BLOCO DE ÁGUA -->
    <div id="agua-block" style="display:none;">
      <div class="card mb-4">
        <div class="card-header">Parâmetros da Água</div>
        <div class="card-body row gy-3">
          <div class="col-3">
            <label>R$ Fatura</label>
            <input name="agua_fatura" type="text" inputmode="decimal"
                   class="form-control form-control-sm"
                   value="{{ agua_fatura_initial|floatformat:2 }}">
          </div>
          <div class="col-3">
            <label>m³ Total</label>
            <input name="agua_m3_total" type="text" inputmode="decimal"
                   class="form-control form-control-sm"
                   value="{{ agua_m3_total_initial|floatformat:4 }}">
          </div>
          <div class="col-3">
            <label>R$/m³</label>
            <input readonly name="agua_valor_m3" type="text" inputmode="decimal"
                   class="form-control form-control-sm"
                   value="{{ agua_valor_m3_initial|floatformat:2 }}">
          </div>
        </div>
      </div>

      <h5>Consumo de Água</h5>
      <table class="table table-bordered table-sm mb-4" id="agua-table">
        <thead>
          <tr>
            <th>Unidade</th>
            <th>Leitura Anterior</th>
            <th>Leitura Atual</th>
            <th>Consumo</th>
            <th>R$</th>
          </tr>
        </thead>
        <tbody>
          {% for u in unidades %}
          <tr>
            <td>
              {% if "sala" in u.nome|lower %}
                Sala Comercial {{ u.nome|slice:"5:" }}
              {% else %}
                Apartamento {{ u.nome }}
              {% endif %}
            </td>
            <td>
              <input type="text" readonly data-unid="{{ u.id }}"
                     value="{{ leituras_agua_anteriores|get_item:u.id|stringformat:'0.3f' }}"
                     class="form-control form-control-sm">
            </td>
            <td>
              <input name="agua_atual_{{ u.id }}" type="text" step="0.0001" inputmode="decimal" min="0"
                     class="form-control form-control-sm">
            </td>
            <td id="td-agua-consumo-{{ u.id }}" style="display:none;">
              <input id="agua_consumo_{{ u.id }}" type="text" readonly
                     class="form-control form-control-sm">
            </td>
            <td id="td-agua-valor-{{ u.id }}" style="display:none;">
              <input id="agua_valor_{{ u.id }}" type="text" readonly
                     class="form-control form-control-sm valor-reais">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- TOTAL ÁGUA -->
      <div class="row mb-4">
        <div class="col-auto d-flex flex-column align-items-center">
          <label><strong>Total (R$):</strong></label>
          <input id="total-agua"
                 type="text"
                 class="form-control form-control-sm valor-reais w-auto"
                 style="max-width: 100px;"
                 readonly>
        </div>
      </div>

    </div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ar = document.querySelector('[name="agua_valor_m3"]');

    function atualizaTotalAgua() {
      let soma = 0;
      document.querySelectorAll('input[id^="agua_valor_"]').forEach(input => {
        const raw = input.value.replace(',', '.').trim();
        if (raw) soma += parseFloat(raw) || 0;
      });
      document.getElementById('total-agua').value = soma.toFixed(2).replace('.', ',');
    }

    document.querySelectorAll('[name^="agua_atual_"]').forEach(inp => {
      const id       = inp.name.split('_').pop();
      const anterior = document.querySelector(`input[data-unid="${id}"]`);
      const tdC      = document.getElementById(`td-agua-consumo-${id}`);
      const tdV      = document.getElementById(`td-agua-valor-${id}`);
      const cField   = document.getElementById(`agua_consumo_${id}`);
      const vField   = document.getElementById(`agua_valor_${id}`);

      function refreshRow() {
        const rawCur = inp.value.replace(',', '.').trim();
        if (!rawCur) {
          cField.value = vField.value = '';
          tdC.style.display = tdV.style.display = 'none';
        } else {
          const cur  = parseFloat(rawCur) || 0;
          const ant  = parseFloat(anterior.value.replace(',', '.')) || 0;
          const diff = cur - ant;
          const cons = diff > 0 ? diff : 0;
          cField.value = cons.toFixed(3);
          const rate = parseFloat(ar.value.replace(',', '.')) || 0;
          vField.value = (cons * rate).toFixed(2).replace('.', ',');
          tdC.style.display = tdV.style.display = '';
        }
        atualizaTotalAgua();
      }

      inp.addEventListener('input', refreshRow);
      refreshRow();
    });
  });
</script>

    <!-- BLOCO DE GÁS -->
    <div id="parametros-gas" style="display:none;" class="mb-4">
      <h5>Parâmetros do Gás</h5>
      <div class="row">
        <div class="col-md-3">
          <label>R$ Recarga:</label>
          <input type="text" id="recarga" name="recarga"
                 class="form-control form-control-lg"
                 value="{{ recarga_initial|default_if_none:'0'|floatformat:2 }}">
        </div>
        <div class="col-md-3">
          <label>KG:</label>
          <input type="text" id="kg" name="kg"
                 class="form-control form-control-lg"
                 value="{{ kg_initial|default_if_none:'1'|floatformat:3 }}">
        </div>
        <div class="col-md-3">
          <label>M³ por KG:</label>
          <input type="text" id="m3_kg" name="m3_kg" step="0.0001"
                 class="form-control form-control-lg"
                 value="{{ m3kg_initial|default_if_none:'1'|floatformat:4 }}">
        </div>
        <div class="col-md-3">
          <label>R$ por M³:</label>
          <input type="text" id="valor_m3" name="valor_m3" readonly
                 class="form-control form-control-lg"
                 value="{{ valor_m3_initial|default_if_none:'0'|floatformat:2 }}">
        </div>
      </div>
    </div>

       <!-- BLOCO DE ENERGIA -->
    <div id="energia-block" style="display:none;" class="mb-4">
      <div class="card mb-4">
        <div class="card-header">Parâmetros:</div>
        <div class="card-body row gy-3">
          <div class="col-3">
            <label>R$ Fatura</label>
            <input id="energia_fatura" name="energia_fatura" type="text" class="form-control"
                   value="{{ energia_fatura_initial|floatformat:2 }}">
          </div>
          <div class="col-3">
            <label>kWh Total</label>
            <input id="energia_kwh_total" name="energia_kwh_total" type="text" class="form-control"
                   value="{{ energia_kwh_total_initial|floatformat:2 }}">
          </div>
          <div class="col-3">
            <label>R$ Custo kWh</label>
            <input id="energia_custo_kwh" name="energia_custo_kwh" type="text"
                   class="form-control form-control-sm"
                   value="{{ energia_custo_kwh_initial|floatformat:2 }}">
          </div>
          <div class="col-3">
            <label>R$ Uso kWh</label>
            <input id="energia_uso_kwh" name="energia_uso_kwh" type="text"
                   class="form-control form-control-sm" readonly
                   value="{{ uso_kwh_initial.u.id|default:0|floatformat:'3' }}">
          </div>
        </div>
      </div>

      <h5 class="mt-4">Leituras de Energia</h5>
      <table class="table table-bordered" id="energia-table">
        <thead class="table-light">
          <tr>
            <th rowspan="2">Unidade</th>
            <th colspan="2">Medidor 1</th>
            <th colspan="2">Total</th>
            <th colspan="2">Medidor 2</th>
          </tr>
          <tr>
            <th>Anter.</th><th>Atual</th>
            <th class="highlight">kWh</th><th class="highlight">R$</th>
            <th>Anter.</th><th>Atual</th>
          </tr>
        </thead>
        <tbody>
          {% for u in unidades %}
          <tr>
            <td>
              {% if 'sala' in u.nome|lower %}
                Sala Comercial {{ u.nome|slice:"5:" }}
              {% else %}
                Apartamento {{ u.nome }}
              {% endif %}
            </td>
            <!-- Medidor 1 -->
        <td>
          <input
            id="energia_med1_ant_{{ u.id }}"
            readonly
            class="form-control form-control-sm"
            value="{{ leituras_energia_anteriores_med1|get_item:u.id|stringformat:'0.4f' }}"
          >
        </td>
        <td>
          <input
            id="energia_med1_atu_{{ u.id }}"
            name="energia_atual1_{{ u.id }}"
            type="text" step="0.0001" inputmode="decimal" min="0"
            class="form-control form-control-sm"
            value=""
            placeholder="0.0000"
          >
        </td>

        <!-- Total -->
        <td class="highlight">
          <input
            id="energia_kwh_{{ u.id }}"
            readonly
            class="form-control form-control-sm"
            placeholder="0,0000"
          >
        </td>
        <td class="highlight">
          <input
            id="energia_valor_{{ u.id }}"
            readonly
            value=""
            class="form-control form-control-sm valor-reais"
          >
        </td>

        <!-- Medidor 2 -->
        <td>
          <input
            id="energia_med2_ant_{{ u.id }}"
            readonly
            class="form-control form-control-sm"
            value="{{ leituras_energia_anteriores_med2|get_item:u.id|stringformat:'0.4f' }}"
          >
        </td>
        <td>
          <input
            id="energia_med2_atu_{{ u.id }}"
            name="energia_atual2_{{ u.id }}"
            type="text" step="0.0001" inputmode="decimal" min="0"
            class="form-control form-control-sm"
            placeholder="0.0000"
          >
        </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Total Energia -->
      <div class="row mb-4">
        <div class="col-auto d-flex flex-column align-items-center">
          <label for="total-leituras-kwh"><strong>Total Leituras (kWh):</strong></label>
          <input id="total-leituras-kwh" readonly
                 class="form-control form-control-sm w-auto"
                 style="max-width: 120px; text-align: right;"
                 placeholder="0,000">
        </div>
        <div class="col-auto d-flex flex-column align-items-center ms-3">
          <label for="total-energia"><strong>Total Energia (R$):</strong></label>
          <input id="total-energia" readonly
                 class="form-control form-control-sm valor-reais w-auto"
                 style="max-width: 100px; text-align: right;">
        </div>
      </div>
    </div>


    <!-- CÁLCULO E RATEIO DE GÁS -->
    <div id="rateio-gas" style="display:none;" class="mb-4">
      <h5>Cálculo de Consumo e Valor</h5>
      <table class="table table-bordered table-sm" id="gas-table">
        <thead>
          <tr>
            <th>Unidade</th>
            <th>Leitura Anterior</th>
            <th>Leitura Atual</th>
            <th>Consumo</th>
            <th>R$</th>
          </tr>
        </thead>
        <tbody>
          {% for unidade in unidades %}
          <tr>
            <td>
              {% if 'Sala' in unidade.nome %}Sala Comercial {{ unidade.nome|slice:'5:' }}
              {% else %}Apartamento {{ unidade.nome }}{% endif %}
            </td>
            <td>
              <input type="text" id="anterior_{{ unidade.id }}"
                     value="{{ leituras_anteriores|get_item:unidade.id|stringformat:'0.4f' }}"
                     class="form-control" readonly>
            </td>
            <td>
              <!-- comece SEM zeros -->
              <input type="text" step="0.0001" inputmode="decimal" min="0" id="atual_{{ unidade.id }}"
                     name="atual_{{ unidade.id }}" class="form-control" value=""
                     oninput="window.calcularConsumo('{{ unidade.id }}', document.getElementById('valor_m3'))">
            </td>
            <td id="td-gas-consumo-{{ unidade.id }}" style="display:none;">
              <input id="consumo_{{ unidade.id }}" class="form-control" readonly>
            </td>
            <td id="td-gas-valor-{{ unidade.id }}" style="display:none;">
              <input id="valor_{{ unidade.id }}" class="form-control valor-reais" readonly>
              <input type="hidden" id="valor_hidden_{{ unidade.id }}"
                     name="valor_gas_{{ unidade.id }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="row mt-2 align-items-end">
        <!-- Coluna do Total -->
        <div class="col-auto d-flex flex-column align-items-center">
          <label><strong>Total (R$):</strong></label>
          <input id="total-gas" type="text"
                 class="form-control form-control-sm valor-reais w-auto"
                 style="max-width: 100px;" readonly>
        </div>

        <!-- Espaço flexível para empurrar a diferença para a direita -->
        <div class="col"></div>

        <!-- Coluna da Diferença -->
        <div class="col-auto d-flex flex-column align-items-center">
          <strong>Diferença Arrecadação e Valor Pago:</strong>
          <input id="diferenca-gas" type="text"
                class="form-control form-control-sm valor-reais w-auto"
                style="max-width: 100px;" readonly>
        </div>
      </div>
    </div>

    {# === BLOCO DE FRAÇÃO === #}
    <div id="rateio-simples" style="display:none;" class="mb-4">
        <h5>Valor:</h5>
        <input
          type="text"
          step="0.01"
          name="valor_unico"
          id="valor_unico"
          class="form-control form-control-lg valor-reais"
          placeholder="R$">

     <div class="mt-3">
        <label for="descricao_unico">Descrição:</label>
        <input
          type="text"
          name="descricao_unico"
          id="descricao_unico"
          class="form-control"
          placeholder="Digite se houver alguma descrição... ">
      </div>
    </div>

    <!-- BLOCO MATERIAL/SERVIÇO -->
    <div id="nf-block" style="display:none;" class="mb-4">
      <h5>Notas Fiscais</h5>
      <table class="table table-bordered" id="nf-table">
        <thead>
          <tr>
            <th>Fornecedor</th>
            <th>Histórico</th>
            <th>NF nº</th>
            <th>Tipo</th>
            <th>R$</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="nf-body">
          <tr>
            <td><input type="text" name="nf_fornecedor_0" class="form-control"></td>
            <td><input type="text" name="nf_historico_0" class="form-control"></td>
            <td><input type="text" name="nf_numero_0" class="form-control"></td>
            <td>
              <select name="nf_tipo_0" class="form-select" style="color: green;">
                <option value="com">Com a Sala</option>
                <option value="sem">Sem a Sala</option>
              </select>
            </td>
            <td><input type="text" name="nf_valor_0" class="form-control valor-reais"></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      <button type="button" id="add-nf" class="btn btn-sm btn-secondary mb-2">Adicionar NF</button>
      <div class="d-flex align-items-end gap-3 flex-wrap">
        <div>
          <label style="color:green;"><strong>Total R$ Com Sala:</strong></label>
          <input id="nf-total-com" type="text" readonly class="form-control form-control-sm valor-reais w-auto" style="max-width:120px;">
        </div>
        <div>
          <label style="color:blue;"><strong>Total R$ Sem Sala:</strong></label>
          <input id="nf-total-sem" type="text" readonly class="form-control form-control-sm valor-reais w-auto" style="max-width:120px;">
        </div>
      </div>
    </div>

    <!-- RATEIO PADRÃO -->
    <div id="bloco-rateio-padrao" style="display:none;"> <h5 class="mt-4">Rateio por Unidade</h5>
        <table class="table table-bordered w-100" id="rateio-padrao"> <thead><tr><th>Unidade</th><th>Valor (R$)</th></tr></thead>
          <tbody>
            {% for unidade in unidades %}
            <tr>
              <td>
                {% if 'Sala' in unidade.nome %}Sala Comercial {{ unidade.nome|slice:'5:' }}
                {% else %}Apartamento {{ unidade.nome }}{% endif %}
              </td>
              <td>
                <input type="text" name="valor_{{ unidade.id }}"
                       class="form-control form-control-lg valor-reais"
                       placeholder="R$">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="row mb-4">
          <div class="col-auto">
            <label><strong>Total Rateio (R$):</strong></label>
            <input id="total-rateio"
                   readonly
                   class="form-control form-control-sm valor-reais w-auto"
                   style="max-width:100px">
          </div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
    <a href="{% url 'lista_despesas' %}" class="btn btn-link mt-3">← Voltar</a>
  </form>

<script>

  // 2) Função que calcula consumo e valor para uma unidade
  function calculaLinhaEnergia(id) {
    const ant1 = parseFloat(document.getElementById(`energia_med1_ant_${id}`)
                                .value.replace(',', '.')) || 0;
    const at1  = parseFloat(document.getElementById(`energia_med1_atu_${id}`)
                                .value.replace(',', '.')) || 0;
    const ant2 = parseFloat(document.getElementById(`energia_med2_ant_${id}`)
                                .value.replace(',', '.')) || 0;
    const at2  = parseFloat(document.getElementById(`energia_med2_atu_${id}`)
                                .value.replace(',', '.')) || 0;

    const consumo = (at1 - ant1) + (at2 - ant2);
    document.getElementById(`energia_kwh_${id}`)
            .value = consumo.toFixed(4).replace('.', ',');

    const custo = parseFloat(custoEl.value.replace(',', '.')) || 0;
    document.getElementById(`energia_valor_${id}`)
            .value = (consumo * custo).toFixed(2).replace('.', ',');
  }

</script>

  <script>
  window.calcularConsumo = function(id, vm3Element) {
    const inp = document.getElementById(`atual_${id}`);
    const raw = inp.value.trim();
    const ant = parseFloat(document.getElementById(`anterior_${id}`).value.replace(',', '.')) || 0;
    const cField = document.getElementById(`consumo_${id}`);
    const vField = document.getElementById(`valor_${id}`);
    const tdC = document.getElementById(`td-gas-consumo-${id}`);
    const tdV = document.getElementById(`td-gas-valor-${id}`);

    if(!raw || parseFloat(raw.replace(',', '.')) === ant) {
        cField.value = '';
        vField.value = '';
        tdC.style.display = 'none';
        tdV.style.display = 'none';
        return;
    }

    const cur = parseFloat(raw.replace(',', '.')) || 0;
    const cons = cur - ant;
    cField.value = cons.toFixed(3);
    const rate = parseFloat(vm3Element.value.replace(',', '.')) || 0;
    vField.value = (cons * rate).toFixed(2).replace('.', ',');
    tdC.style.display = '';
    tdV.style.display = '';

    atualizaTotalGas();
    atualizaDiferenca();
};

  document.addEventListener('DOMContentLoaded', function() {
    // elementos comuns
    const tipoSelect   = document.getElementById('id_tipo'),
          aguaBlock    = document.getElementById('agua-block'),
          pg           = document.getElementById('parametros-gas'),
          rg           = document.getElementById('rateio-gas'),
          rs           = document.getElementById('rateio-simples'),
          rp           = document.getElementById('bloco-rateio-padrao'),
          recargaInput = document.getElementById('recarga'),
          kgInput      = document.getElementById('kg'),
          m3kgInput    = document.getElementById('m3_kg'),
          vm3          = document.getElementById('valor_m3'),
          af           = document.querySelector('[name="agua_fatura"]'),
          at           = document.querySelector('[name="agua_m3_total"]'),
          ar           = document.querySelector('[name="agua_valor_m3"]');
          energiaBlock     = document.getElementById('energia-block'),
          energiaFaturaEl  = document.querySelector('[name="energia_fatura"]'),
          energiaKwhTotal  = document.querySelector('[name="energia_kwh_total"]'),
          energiaCustoEl   = document.getElementById('energia_custo_kwh'),
          nfBlock      = document.getElementById('nf-block'),
          nfBody       = document.getElementById('nf-body'),
          nfTotalCom   = document.getElementById('nf-total-com'),
          nfTotalSem   = document.getElementById('nf-total-sem');
    const materialTipo = 'material/serviço de consumo';
    const reparoTipo   = 'reparos/reforma';

    function atualizaRate() {
          const f = parseFloat(af.value.replace(',', '.')) || 0;
          const m = parseFloat(at.value.replace(',', '.')) || 0;
          ar.value = m ? (f / m).toFixed(2).replace('.', ',') : '';
          document.querySelectorAll('[name^="agua_atual_"]').forEach(el =>
              el.dispatchEvent(new Event('input'))
          );
      }

      af.addEventListener('input', atualizaRate);
      at.addEventListener('input', atualizaRate);
      atualizaRate();

    function nfTotalCalc(){
        let somaCom = 0, somaSem = 0;
        nfBody.querySelectorAll('tr').forEach(row => {
          const valorInp = row.querySelector('input[name^="nf_valor_"]');
          const tipoSel  = row.querySelector('select[name^="nf_tipo_"]');
          const val = valorInp ? parseFloat(valorInp.value.replace(',', '.'))||0 : 0;
          const tipo = tipoSel ? tipoSel.value : 'com';
          if (tipo === 'sem') somaSem += val; else somaCom += val;
        });
        nfTotalCom.value = somaCom.toFixed(2).replace('.', ',');
        nfTotalSem.value = somaSem.toFixed(2).replace('.', ',');
        document.getElementById('id_valor_total').value = (somaCom + somaSem).toFixed(2);
      }

      function updateTipoColor(sel){
        if(!sel) return;
        sel.style.color = sel.value === 'sem' ? 'blue' : 'green';
      }

      document.getElementById('add-nf').addEventListener('click', () => {
          const idx = nfBody.querySelectorAll('tr').length;
          const row = document.createElement('tr');
          row.innerHTML =
            `<td><input type="text" name="nf_fornecedor_${idx}" class="form-control"></td>` +
            `<td><input type="text" name="nf_historico_${idx}" class="form-control"></td>` +
            `<td><input type="text" name="nf_numero_${idx}" class="form-control"></td>` +
            `<td><select name="nf_tipo_${idx}" class="form-select"><option value="com" style="color:green;">Com a Sala</option><option value="sem" style="color:blue;">Sem a Sala</option></select></td>` +
            `<td><input type="text" name="nf_valor_${idx}" class="form-control valor-reais"></td>` +
            `<td><button type="button" class="btn btn-sm btn-danger remove-row">&times;</button></td>`;
          nfBody.appendChild(row);
          updateTipoColor(row.querySelector('select[name^="nf_tipo_"]'));
          const newElems = row.querySelectorAll('input, select');
          fields.push(...newElems);
          newElems.forEach(setupEnterNavigation);
          nfTotalCalc();
        });

      nfBlock.addEventListener('click', e=>{
        if(e.target.classList.contains('remove-row')){
          e.target.closest('tr').remove();
          nfTotalCalc();
        }
      });

      nfBlock.addEventListener('input', e=>{
        if(e.target.name && e.target.name.startsWith('nf_valor_')){
          nfTotalCalc();
        }
      });

      nfBlock.addEventListener('change', e=>{
        if(e.target.name && e.target.name.startsWith('nf_tipo_')){
          updateTipoColor(e.target);
          nfTotalCalc();
        }
      });

      // lista de tipos que usam apenas o bloco "simples"
    const simplesText = [
      'serviço - faxina',
      'salário - síndico',
      'elevador',
      'material consumo (sem sala comercial)',
      'taxa boleto',
      'seguro 6x',
      'honorários contábeis',
      'fatura energia elétrica'
    ];

      // nova função para atualizar o Total
    function atualizaTotalGas() {
      let soma = 0;
      document.querySelectorAll('input[id^="valor_"]').forEach(input => {
        if (input.id === 'valor_m3') return;
        const raw = input.value.replace(',', '.').trim();
        if (raw) soma += parseFloat(raw) || 0;
      });
      const totalStr = soma.toFixed(2).replace('.', ',');
      // mostra na tela
      document.getElementById('total-gas').value = totalStr;
      // ** guarda no campo que o Django vai salvar **
      document.getElementById('id_valor_total').value =
        totalStr.replace('.', '.'); // aqui usamos ponto decimal
    }
      window.calcularConsumo = function(id, vm3Element) {
        const inp    = document.getElementById(`atual_${id}`);
        const raw    = inp.value.trim();
        const ant    = parseFloat(document.getElementById(`anterior_${id}`)
                                  .value.replace(',', '.'))||0;
        const cField = document.getElementById(`consumo_${id}`);
        const vField = document.getElementById(`valor_${id}`);
        const tdC    = document.getElementById(`td-gas-consumo-${id}`);
        const tdV    = document.getElementById(`td-gas-valor-${id}`);

        if (!raw || parseFloat(raw.replace(',', '.')) === ant) {
          cField.value = '';
          vField.value = '';
          tdC.style.display = 'none';
          tdV.style.display = 'none';
          atualizaTotalGas();
          atualizaDiferenca();
          return;
        }

        const cur  = parseFloat(raw.replace(',', '.'))||0;
        const cons = cur - ant;
        cField.value = cons.toFixed(3);
        const rate = parseFloat(vm3Element.value.replace(',', '.'))||0;
        vField.value = (cons * rate).toFixed(2).replace('.', ',');
        tdC.style.display = '';
        tdV.style.display = '';
        atualizaTotalGas();
        atualizaDiferenca();
      };

    // atualiza o campo Diferença = Total (R$) – R$ Recarga
    function atualizaDiferenca() {
      const totalEl   = document.getElementById('total-gas'),
            recargaEl = document.getElementById('recarga'),
            diffEl    = document.getElementById('diferenca-gas');

      const total   = parseFloat(totalEl.value.replace(',', '.')) || 0,
            recarga = parseFloat(recargaEl.value.replace(',', '.')) || 0;

      diffEl.value = (total - recarga)
                        .toFixed(2)
                        .replace('.', ',');
    }

    // função de visibilidade
    function atualizarVisibilidade() {
        const tipoSelect = document.getElementById('id_tipo');
        if (!tipoSelect || tipoSelect.options.length === 0) return;
        const txt = tipoSelect.options[tipoSelect.selectedIndex].text.toLowerCase();

        // Esconde todos os blocos primeiro
        aguaBlock.style.display = 'none';
        pg.style.display = 'none';
        rg.style.display = 'none';
        rs.style.display = 'none';
        rp.style.display = 'none';
        energiaBlock.style.display = 'none';
        nfBlock.style.display = 'none';

        // Mostra apenas o bloco correto
        if (txt.includes('água')) {
            aguaBlock.style.display = 'block';
        }
        else if (txt.includes('gás')) {
            pg.style.display = 'block';
            rg.style.display = 'block';
        }
        else if (txt === 'energia salão') {
            energiaBlock.style.display = 'block';
        }
        else if (txt === 'energia áreas comuns') {
            aguaBlock.style.display = 'none'
            pg.style.display        = 'none'
            rg.style.display        = 'none'
            rs.style.display        = 'block'
            rp.style.display        = 'none'
        }
        else if (txt === materialTipo || txt === reparoTipo) {
            nfBlock.style.display = 'block';
        }
        else if (simplesText.some(item => txt.includes(item.toLowerCase()))) {
            rs.style.display = 'block';
        }
        else {
            rp.style.display = 'block';
            }
        }

        tipoSelect.addEventListener('change', atualizarVisibilidade);
        atualizarVisibilidade();

        // formatação ENTER/TAB
        const formEl = document.querySelector('form[method="post"]');
        let fields = Array.from(formEl.querySelectorAll('input:not([type=hidden]), select'));
        function formatField(f) {
          if (!f.classList.contains('valor-reais')) return;
          const v = parseFloat(f.value.replace(',', '.'));
          if (!isNaN(v)) f.value = v.toFixed(2).replace('.', ',');
        }
        function setupEnterNavigation(el) {
          el.addEventListener(
            'keydown',
            e => {
              if (e.key === 'Enter') {
                e.preventDefault();
                formatField(el);
                const idx = fields.indexOf(el);
                if (fields[idx + 1]) fields[idx + 1].focus();
              } else if (e.key === 'Tab') {
                formatField(el);
              }
            },
            { capture: true }
          );
        }

        fields.forEach(setupEnterNavigation);
        formEl.querySelectorAll('input.valor-reais').forEach(f =>
          f.addEventListener('blur', ()=>formatField(f))
        );

    // função de recálculo por linha:
    document
      .getElementById('energia-table')
      .addEventListener('input', e => {
        const m = e.target.id.match(/^energia_med[12]_atu_(\d+)$/);
        if (!m) return;
        const id = m[1];

        // anteriores
        const ant1 = parseFloat(
          document
            .getElementById(`energia_med1_ant_${id}`)
            .value
            .replace(',', '.')
        ) || 0;
        const ant2 = parseFloat(
          document
            .getElementById(`energia_med2_ant_${id}`)
            .value
            .replace(',', '.')
        ) || 0;

        // atuais
        const cur1 = parseFloat(
          document
            .getElementById(`energia_med1_atu_${id}`)
            .value
            .replace(',', '.')
        );
        const cur2 = parseFloat(
          document
            .getElementById(`energia_med2_atu_${id}`)
            .value
            .replace(',', '.')
        );

        // consumo
        const consumo =
          (isNaN(cur1) ? 0 : cur1 - ant1) +
          (isNaN(cur2) ? 0 : cur2 - ant2);

        // taxa de uso (não mais o custo)
        const usoRate = parseFloat(
          document
            .getElementById('energia_uso_kwh')
            .value
            .replace(',', '.')
        ) || 0;

        // atualiza kWh
        const kwhEl = document.getElementById(`energia_kwh_${id}`);
        kwhEl.value = isNaN(consumo)
          ? ''
          : consumo.toFixed(3).replace('.', ',');

        // atualiza R$
        const valEl = document.getElementById(`energia_valor_${id}`);
        valEl.value = isNaN(consumo)
          ? ''
          : (consumo * usoRate).toFixed(2).replace('.', ',');

        // recalcula total geral
        let soma = 0;
        document.querySelectorAll('input[id^="energia_valor_"]').forEach(i => {
          soma += parseFloat(i.value.replace(',', '.')) || 0;
        });
        document.getElementById('total-energia')
                .value = soma.toFixed(2).replace('.', ',');
      });

    // No final do DOMContentLoaded
    document.querySelectorAll('input[id^="energia_med1_atu_"]').forEach(i => {
      const id = i.id.split('_').pop();
      recalcRow(id);
    });
    recalcTotal();

    // --- Gás ---
    function calcVM3(){
        const r = parseFloat(recargaInput.value.replace(',', '.'))||0;
        const k = parseFloat(kgInput.value.replace(',', '.'))||0;
        const m = parseFloat(m3kgInput.value.replace(',', '.'))||0;
        vm3.value = (k&&m) ? ((r/k)*m).toFixed(2).replace('.', ',') : '';
        document.querySelectorAll('[id^="atual_"]').forEach(el=>
        calcularConsumo(el.id.split('_')[1])
      );
        atualizaTotalGas();
        atualizaDiferenca(); // sua função existente que preenche #diferenca-gas
    }
    recargaInput.addEventListener('input', calcVM3);
    kgInput     .addEventListener('input', calcVM3);
    m3kgInput   .addEventListener('input', calcVM3);
    calcVM3();
    nfBody.querySelectorAll('select[name^="nf_tipo_"]').forEach(updateTipoColor);
    nfTotalCalc();
  });
  </script>
 <script>
 function updateRowVisibility(row) {
      const med1Atual = row.querySelector('[id^="energia_med1_atu_"]');
      const med2Atual = row.querySelector('[id^="energia_med2_atu_"]');

      // Verifica se pelo menos um medidor tem valor
      const hasValue = (med1Atual && med1Atual.value !== '') ||
                       (med2Atual && med2Atual.value !== '');

      // Adiciona/remove classe conforme necessário
      if (hasValue) {
        row.classList.add('has-reading');
      } else {
        row.classList.remove('has-reading');
      }
    }

    // Aplica a todas as linhas
    document.querySelectorAll('#energia-table tbody tr').forEach(row => {
      // Monitora ambos os medidores
      const med1Atual = row.querySelector('[id^="energia_med1_atu_"]');
      const med2Atual = row.querySelector('[id^="energia_med2_atu_"]');

      if (med1Atual) {
        med1Atual.addEventListener('input', () => updateRowVisibility(row));
      }

      if (med2Atual) {
        med2Atual.addEventListener('input', () => updateRowVisibility(row));
      }

      // Verificação inicial
      updateRowVisibility(row);
    });

(function(){
  const custoEl = document.getElementById('energia_custo_kwh');
  const usoEl    = document.getElementById('energia_uso_kwh');
  const tabela  = document.getElementById('energia-table');
  const totalEl = document.getElementById('total-energia');

  // 1) Recalcula UMA linha inteira dado um evento num input de "Atual"
 function recalcRow(id) {
    const ant1 = parseFloat(document.getElementById(`energia_med1_ant_${id}`).value) || 0;
    const cur1Input = document.getElementById(`energia_med1_atu_${id}`);
    const cur1 = parseFloat(cur1Input.value) || 0;

    const ant2 = parseFloat(document.getElementById(`energia_med2_ant_${id}`).value) || 0;
    const cur2Input = document.getElementById(`energia_med2_atu_${id}`);
    const cur2 = parseFloat(cur2Input.value) || 0;

    // 2. Atualiza a visibilidade dos inputs (isso pode ser para estilização, não essencial para a correção)
    toggleValueVisibility(cur1Input);
    toggleValueVisibility(cur2Input);

    // 3. A Lógica Corrigida:
    //    - Se ALGUM dos campos "Atual" tiver um valor (diferente de vazio), calcula o consumo.
    //    - Caso contrário (AMBOS os campos "Atual" estiverem vazios), define o kWh como "0.0000".
    if (cur1Input.value !== '' || cur2Input.value !== '') {
        const consumo = (cur1 - ant1) + (cur2 - ant2);
        document.getElementById(`energia_kwh_${id}`).value = consumo.toFixed(4);
        document.getElementById(`energia_valor_${id}`).value = (consumo * usoKwh).toFixed(2);
    } else {
        document.getElementById(`energia_kwh_${id}`).value = '0.0000';  // A CORREÇÃO ESTÁ AQUI!
        document.getElementById(`energia_valor_${id}`).value = '';
    }
}

    const uso = parseFloat(usoEl.value.replace(',', '.'))||0;
    document.getElementById(`energia_valor_${id}`)
            .value = (consumo * uso).toFixed(2).replace('.', ',');

  } else {
    kwhCell.classList.remove('has-value');
    valorCell.classList.remove('has-value');
    document.getElementById(`energia_kwh_${id}`).value = '';
    document.getElementById(`energia_valor_${id}`).value = '';
  }

  // 2) Soma todos os valores e joga no total
  function recalcTotal() {
    let soma = 0;
    tabela.querySelectorAll('input[id^="energia_valor_"]').forEach(i => {
      soma += parseFloat(i.value.replace(',', '.')) || 0;
    });
    totalEl.value = soma.toFixed(2).replace('.', ',');
  }

  // 3) Quando o custo mudar, refaz **todas** as linhas
  custoEl.addEventListener('input', () => {
    tabela.querySelectorAll('input[id^="energia_med1_atu_"], input[id^="energia_med2_atu_"]')
          .forEach(i => {
            const id = i.id.split('_').pop();
            recalcRow(id);
          });
    recalcTotal();
  });

  // 4) Escuta qualquer digitação nos inputs “Atual” (medidor 1 ou 2)
  tabela.addEventListener('input', e => {
      const m = e.target.id.match(/^energia_med[12]_atu_(\d+)$/);
      if (m) {
        recalcRow(m[1]);
        recalcTotal();
      }
    });

  // 5) dispara um recalculo inicial caso haja valores pré-carregados
  tabela.querySelectorAll('input[id^="energia_med1_atu_"]').forEach(i => {
    const id = i.id.split('_').pop();
    recalcRow(id);
  });
  recalcTotal();
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  // 1) pega o custo por kWh
  const custoKwh = parseFloat(
    document.getElementById('energia_custo_kwh').value.replace(',', '.')
  ) || 0;

  // 2) funções de cálculo
  function calculaLinhaEnergia(id) {
    const ant1 = parseFloat(document.getElementById(`energia_med1_ant_${id}`)
                                .value.replace(',', '.')) || 0;
    const at1_input = document.getElementById(`energia_med1_atu_${id}`);
    const at1 = parseFloat(at1_input.value.replace(',', '.')) || 0;
    const ant2 = parseFloat(document.getElementById(`energia_med2_ant_${id}`)
                                .value.replace(',', '.')) || 0;
    const at2_input = document.getElementById(`energia_med2_atu_${id}`);
    const at2 = parseFloat(at2_input.value.replace(',', '.')) || 0;

    let consumo = 0;
     // Calcula o consumo apenas se algum dos campos 'Atual' tiver valor
    if (at1_input.value !== '' || at2_input.value !== '') {
        consumo = (at1 - ant1) + (at2 - ant2);
     }

    document.getElementById(`energia_kwh_${id}`)
            .value = consumo.toFixed(4).replace('.', ',');

    const custo = parseFloat(document.getElementById('energia_uso_kwh').value.replace(',', '.')) || 0;
    document.getElementById(`energia_valor_${id}`)
            .value = (consumo * custo).toFixed(2).replace('.', ',');
    }

    function toggleValueVisibility(input) {
      if (input.value === '' || input.value === '0.0000') {
        input.style.color = 'transparent';
      } else {
        input.style.color = '';
      }
    }

    document.querySelectorAll('[id^="energia_med1_atu_"], [id^="energia_med2_atu_"]').forEach(input => {
      // Verificação inicial
      toggleValueVisibility(input);

      // Evento para quando o valor muda
      input.addEventListener('input', function() {
        toggleValueVisibility(this);
        const id = this.id.split('_').pop();
        recalcRow(id);
        recalcTotal();
      });
    });

  function atualizaTotalEnergia() {
    // Calcula o Total Energia (R$)
    let somaReais = 0;
    document.querySelectorAll('input[id^="energia_valor_"]').forEach(i => { // Campos de valor em R$ por unidade
      somaReais += parseFloat(i.value.replace(',', '.')) || 0;
    });
    const totalEnergiaInput = document.getElementById('total-energia');
    if (totalEnergiaInput) {
        totalEnergiaInput.value = somaReais.toFixed(2).replace('.', ',');
    }

    // Calcula o Total Leituras (kWh)
    let somaKwh = 0;
    document.querySelectorAll('input[id^="energia_kwh_"]').forEach(i => {
        somaKwh += parseFloat(i.value.replace(',', '.')) || 0;
    });
    const totalLeiturasKwhInput = document.getElementById('total-leituras-kwh');
    if (totalLeiturasKwhInput) {
        totalLeiturasKwhInput.value = somaKwh.toFixed(3).replace('.', ',');
    }
  }

  // 3) aplica em todas as linhas da tabela #energia-table
  document
    .querySelectorAll('table#energia-table tbody tr')
    .forEach(row => {
      const inp1 = row.querySelector('[id^="energia_med1_atu_"]');
      const inp2 = row.querySelector('[id^="energia_med2_atu_"]');
      if (!inp1 || !inp2) return;

      const id = inp1.id.split('_').pop();
      [inp1, inp2].forEach(inp =>
        inp.addEventListener('input', () => {
          calculaLinhaEnergia(id);
          atualizaTotalEnergia();
        })
      );

      // cálculo inicial
      calculaLinhaEnergia(id);
    });

  // 4) cálculo inicial do total
  atualizaTotalEnergia();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const custoEl = document.getElementById('energia_custo_kwh');
  const usoEl   = document.getElementById('energia_uso_kwh');

  function atualizaUso() {
    const custo = parseFloat(custoEl.value.replace(',', '.')) || 0;
    usoEl.value = (custo * 3).toFixed(2).replace('.', ',');
  }

  custoEl.addEventListener('input', atualizaUso);
  atualizaUso();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // elementos de parâmetro do gás
  const recEl  = document.getElementById('recarga'),
        kgEl   = document.getElementById('kg'),
        m3kgEl = document.getElementById('m3_kg'),
        outEl  = document.getElementById('valor_m3');

  function recalcGasRate() {
    // converte vírgula para ponto e parseFloat
    const rec  = parseFloat(recEl.value.replace(',', '.'))   || 0;
    const kg   = parseFloat(kgEl.value.replace(',', '.'))    || 1;
    const m3kg = parseFloat(m3kgEl.value.replace(',', '.'))  || 1;
    // evita divisão por zero
    const rate = (rec / kg) * m3kg;
    // escreve de volta, formatando com duas casas e vírgula
    outEl.value = rate.toFixed(2).replace('.', ',');
  }

  // dispara recálculo ao digitar em qualquer campo
  [recEl, kgEl, m3kgEl].forEach(el =>
    el.addEventListener('input', recalcGasRate)
  );

  // recalc inicial
  recalcGasRate();
});
</script>
<script>
// intercepta todo input com step="0.0001"
document.querySelectorAll('input[step="0.0001"]').forEach(function(inp) {
  function truncate() {
    const pos = inp.selectionStart;
    let val = inp.value.replace(',', '.');
    if (val.includes('.')) {
      const parts = val.split('.');
      // truncar apenas se fracção > 4 dígitos
      if (parts[1].length > 4) {
        val = parts[0] + '.' + parts[1].slice(0,4);
      }
    }
    inp.value = inp.value.includes(',') ? val.replace('.', ',') : val;
    if (pos !== null) inp.setSelectionRange(pos, pos);
  }
  inp.addEventListener('input', truncate);
  inp.addEventListener('paste', function(e) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text');
    const num  = parseFloat(text.replace(',', '.'));
    if (!isNaN(num)) {
      const s = num.toString().split('.');
      const val = s[0] + (s[1] ? '.' + s[1].slice(0,4) : '');
      inp.value = text.includes(',') ? val.replace('.', ',') : val;
    }
  });
});

// 1) função que soma todos os rateios e atualiza o total
function atualizaTotalRateio() {
  let soma = 0;
  document
    .querySelectorAll('#rateio-padrao input[name^="valor_"]')
    .forEach(i => {
      const v = parseFloat(i.value.replace(',', '.')) || 0;
      soma += v;
    });
  // mostra na tela
  document.getElementById('total-rateio').value =
    soma.toFixed(2).replace('.', ',');
  // guarda no campo hidden para o Django salvar
  document.getElementById('id_valor_total').value =
    soma.toFixed(2);  // ponto decimal aqui
}

// 2) dispara a soma toda vez que alguém digitar em um rateio
document
  .querySelectorAll('#rateio-padrao input[name^="valor_"]')
  .forEach(i => i.addEventListener('input', atualizaTotalRateio));

// 3) cálculo inicial, caso haja valores pré-carregados
atualizaTotalRateio();

(function(){
    // 1) Função que soma todos os campos de kWh e preenche o total
    function atualizarTotalLeituras() {
      let somaKwh = 0;
      document
        .querySelectorAll('input[id^="energia_kwh_"]:not(#energia_kwh_total)')
        .forEach(input => {
          somaKwh += parseFloat(input.value.replace(',', '.')) || 0;
        });
      document
        .getElementById('total-leituras-kwh')
        .value = somaKwh.toFixed(3).replace('.', ',');
    }

    // 2) Captura qualquer digitação na tabela de energia
    const tabela = document.getElementById('energia-table');
    if (tabela) {
      tabela.addEventListener('input', function(e){
        // dispara sempre que muda um "Atual" ou um kWh recalculado
        if (/^energia_med[12]_atu_/.test(e.target.id) || /^energia_kwh_/.test(e.target.id)) {
          atualizarTotalLeituras();
        }
      });
    }

    // 3) Faz a soma inicial quando a página carregar
document.addEventListener('DOMContentLoaded', atualizarTotalLeituras);
  })();

</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input.valor-reais, input[type="number"], input[step="0.0001"]').forEach(inp => {
      if (inp.type === 'number' || inp.matches('[step="0.0001"]')) {
        inp.setAttribute('min', '0');
        inp.setAttribute('inputmode', 'decimal');
      }
      inp.addEventListener('input', () => {
        const pos = inp.selectionStart;
        let val = inp.value.replace(/[^0-9.,]/g, '');
        if (val.startsWith('-')) {
          val = val.slice(1);
        }
        inp.value = val;
        if (pos !== null) inp.setSelectionRange(pos, pos);
      });
    });
  });
</script>
{% endblock %}
